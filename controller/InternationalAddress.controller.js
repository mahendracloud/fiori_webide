sap.ui.define(["ugiaiwui/mdg/aiw/request/controller/BaseController","sap/ui/model/json/JSONModel","sap/m/MessageBox","sap/ui/core/routing/History","ugiaiwui/mdg/aiw/request/model/formatter","sap/ui/core/routing/Router","ugiaiwui/mdg/aiw/library/js/ValueHelpProvider","sap/m/BusyDialog","sap/ui/core/message/Message"],function(e,t,r,n,s,i,o,l,d){"use strict";return e.extend("ugiaiwui.mdg.aiw.request.controller.InternationalAddress",{onInit:function(){this._oView=this.getView();this._oComponent=sap.ui.component(sap.ui.core.Component.getOwnerIdFor(this.getView()));this.getRouter().getRoute("intlAddr").attachPatternMatched(this._onRouteMatched,this);var e=this._oComponent.getModel();e.setDefaultCountMode(sap.ui.model.odata.CountMode.None);this.getView().setModel(e);var r=this._oComponent.getModel("NewModel");this.getView().setModel(r,"valueHelp");var a=this._oComponent.getModel("NewModel2");this.getView().setModel(a,"valueHelp2");this.readAddressVersion(this);this.readAddressTitle();var n={enabled:true};this.getView().setModel(new t(n),"mainView");var s=sap.ui.getCore().getMessageManager();this.getView().setModel(s.getMessageModel(),"message");s.registerObject(this.getView(),true)},_onRouteMatched:function(e){var r=this;var a=e.getParameter("name");if(a==="intlAddr"){var n=e.getParameter("arguments").sCrStatus;var s=e.getParameter("arguments").modelName;var i=decodeURIComponent(e.getParameter("arguments").itemPath);this.sIntlPath=parseInt(i.split("/")[2]);this.rowIndex=decodeURIComponent(e.getParameter("arguments").rowIndex);this.viewName=e.getParameter("arguments").viewName;var o=e.getParameter("arguments").addrEnable;this.currentHeader;if(this.viewName.indexOf("Approve")>-1){var l="/"+s+this.rowIndex;this.currentHeader=sap.ui.getCore().getModel("AIWAPPROVE").getProperty(l)}else if(this.viewName.indexOf("Change")>-1){this.currentHeader=sap.ui.getCore().getModel(s).getData()}else{this.currentHeader=sap.ui.getCore().getModel(s).getProperty(this.rowIndex)}this.currentObj=this.currentHeader.intlAddr[this.sIntlPath];var d=new t(this.currentObj);this.oModelName="intlAddrModel";this.getView().setModel(d,this.oModelName);if(this.currentObj.AdNation!==""){this.getView().byId("idSELAddrVrsnIA").setSelectedKey(this.currentObj.AdNation)}else{this.getView().byId("idSELAddrVrsnIA").setSelectedKey()}var m=this.getView().getModel("mainView").getData();if(n==="true"||this.viewName==="Approve"||o==="false"){m.enabled=false}else{m.enabled=true}this.getView().getModel("mainView").refresh()}},onAddrVersionChange:function(e){var t=this;var r=e.getSource();var a=this.sIntlPath;var n=e.getParameter("selectedItem").getKey();var s=false;var i=this.currentHeader;var o=i.intlAddr;for(var l=0;l<o.length;l++){if(l===a){continue}if(o[l].AdNation===n){s=true;t.createMessagePopover("Address Version already exists","Error");t.currentObj.AdNation="";r.setSelectedKey();break}}if(!s){t.currentObj.AdNation=r.getSelectedKey();t.currentObj.AdNationEnable=false;this.getView().getModel("intlAddrModel").setData(t.currentObj)}},onItmDonePress:function(e){var t=e.getSource().getId();if(t.indexOf("idBtnCheck")>-1){this.validateCheck();return}var r=n.getInstance().getPreviousHash();if(r!==undefined){history.go(-1)}},validateCheck:function(){var e=this;var t=this.currentHeader;var r=sap.ui.getCore().getModel("tempCrTypeModel").getData();var n={ChangeRequestType:r.crtype,CrDescription:r.desc,IsDraft:"C",Messages:[],FuncLoc:[],FLAddr:[],FLAddrI:[],FLLAM:[],FLClass:[],FLVal:[],Equipment:[],EqAddr:[],EqAddrI:[],EqPRT:[],EqLAM:[],EqClass:[],EqVal:[],MSPoint:[],MSLAM:[],MSClass:[],MSVal:[],MPLAN:[],MPItem:[],MPLAM:[],MPOBList:[],MPCycle:[],MRBHeader:[],MRBItem:[],MRBSBIT:[],EBHeader:[],EBItem:[],EBSBIT:[],FBHeader:[],FBItem:[],FBSBIT:[],WBHeader:[],WBItem:[],WBSBIT:[],ONetwork:[],ONLAM:[],Workcenter:[],WCCost:[],GTList:[],GTOprs:[],GTComp:[],GTClass:[],GTVal:[],ETList:[],ETOprs:[],ETComp:[],ETClass:[],ETVal:[],FTList:[],FTOprs:[],FTComp:[],FTClass:[],FTVal:[],Olink:[],OLClass:[],OLVal:[]};if(this.viewName.indexOf("Floc")>-1){var i={Tplnr:t.Functionallocation,Txtmi:t.Flocdescription,TplkzFlc:t.Strucindicator,Tplxt:t.StrucIndicatorDesc,EditMask:t.EditMask,Hierarchy:t.Hierarchy,Fltyp:t.Floccategory,Flttx:t.FlocCategoryDesc,Swerk:t.Maintplant,Plantname:t.MaintplantDesc,StorFloc:t.Location,Locationdesc:t.Locationdesc,Abckzfloc:t.Abckz,Abctx:t.Abctx,Bukrsfloc:t.Bukrs,Butxt:t.Butxt,City:t.City,KostFloc:t.Kostl,KokrFloc:t.Kokrs,Contareaname:t.Mctxt,PlntFloc:t.Werks,Planningplantdes:t.Planningplantdes,Ingrp:t.Ingrp,Plannergrpdesc:t.Innam,Arbplfloc:t.Arbpl,Wergwfloc:t.WcWerks,Gewrkfloc:t.MainArbpl,MainWcPlant:t.MainWerks,Tplma:t.SupFunctionallocation,Supflocdesc:t.SupFlocdescription,BeberFl:t.BeberFl,Fing:t.Fing,Tele:t.Tele,Submtiflo:t.ConstrType,Constdesc:t.ConstructionDesc,Eqart:t.TechnicalObjectTyp,Eartx:t.Description,Stattext:t.Stattext,StsmFloc:t.StsmEqui,Statproftxt:t.StsmEquiDesc,UstwFloc:t.UstwEqui,UswoFloc:t.UswoEqui,UstaFloc:t.UstaEqui,Adrnri:t.Adrnri,Deact:t.Deact};n.FuncLoc.push(i);var o={Funcloc:t.Functionallocation,Title:t.TitleCode,Name1:t.Name1,Name2:t.Name2,Name3:t.Name3,Name4:t.Name4,Sort1:t.Sort1,Sort2:t.Sort2,NameCo:t.NameCo,PostCod1:t.PostCod1,City1:t.City1,Building:t.Building,Floor:t.Floor,Roomnum:t.Roomnum,Strsuppl1:t.Strsuppl1,Strsuppl2:t.Strsuppl2,Strsuppl3:t.Strsuppl3,Location:t.AddrLocation,RPostafl:t.RefPosta,Landx:t.Landx,TimeZone:t.TimeZone,RPostFl:t.Region,Regiotxt:t.RegionDesc};n.FLAddr.push(o);var l=t.intlAddr;if(l){for(var d=0;d<l.length;d++){n.FLAddrI.push(l[d])}}if(t.Floccategory==="L"&&t.lam){var m={Funcloc:t.Functionallocation,Lrpid:t.lam.Lrpid,Strtptatr:t.lam.Strtptatr,Endptatr:t.lam.Endptatr,Length:t.lam.Length.toString(),LinUnit:t.lam.LinUnit,Startmrkr:t.lam.Startmrkr,Endmrkr:t.lam.Endmrkr,Mrkdisst:t.lam.Mrkdisst,Mrkdisend:t.lam.Mrkdisend,MrkrUnit:t.lam.MrkrUnit};n.FLLAM.push(m)}var p=t.classItems;if(p){if(p.length>0){for(var u=0;u<p.length;u++){var g={Funcloc:t.Functionallocation,Classtype:p[u].Classtype,Class:p[u].Class,Clstatus1:p[u].Clstatus1};n.FLClass.push(g)}}}var c=t.characteristics;if(c){if(c.length>0){for(var h=0;h<c.length;h++){var C={Funcloc:AIWFLOCModel[a].Functionallocation,Atnam:c[h].Atnam,Textbez:c[h].Textbez,Atwrt:c[h].Atwrt,Class:c[h].Class};n.FLVal.push(C)}}}}if(this.viewName.indexOf("Equi")>-1){var x={Herst:t.Herst,Equnr:t.Equnr,Txtmi:t.Eqktx,Swerk:t.Maintplant,Name1:t.MaintplantDesc,TplnEilo:t.Tplnr,Flocdescription:t.Pltxt,Eqtyp:t.EquipmentCatogory,Etytx:t.EquipCatgDescription,Eqart:t.TechnicalObjectTyp,Eartx:t.Description,Typbz:t.Typbz,SubmEeqz:t.ConstrType,Constdesc:t.ConstructionDesc,BukrEilo:t.Bukrs,Butxt:t.Butxt,HequEeqz:t.SuperordinateEquip,SuperordEqDes:t.SuperordinateEquipDesc,TidnEeqz:t.TechIdNum,KostEilo:t.Kostl,KokrEilo:t.Kokrs,Contareaname:t.Mctxt,StorEilo:t.Location,Locationdesc:t.Locationdesc,AbckEilo:t.Abckz,Abctx:t.Abctx,PplaEeqz:t.Werks,Planningplantdes:t.Planningplantdes,IngrEeqz:t.Ingrp,Plannergrpdesc:t.Innam,Serge:t.Serge,MapaEeqz:t.MapaEeqz,Stattext:t.Stattext,StsmEqui:t.StsmEqui,Statproftxt:t.StsmEquiDesc,UstwEqui:t.UstwEqui,UswoEqui:t.UswoEqui,UstaEqui:t.UstaEqui,Deact:t.Deact,Answt:t.Answt,Ansdt:e._formatDate(t.Ansdt),Waers:t.Waers,ArbpEilo:t.Arbpl,WorkCenterPlant:t.WcWerks,ArbpEeqz:t.MainArbpl,MainWcPlant:t.MainWerks,BebeEilo:t.BeberFl,Fing:t.Fing,Tele:t.Tele,HeqnEeqz:t.EquipPosition,Adrnri:t.Adrnri,Funcid:t.Funcid,Frcfit:t.Frcfit,Frcrmv:t.Frcrmv};n.Equipment.push(x);var w={Equi:t.Equnr,PlanvPrt:t.PlanvPrt,SteufPrt:t.SteufPrt,KtschPrt:t.KtschPrt,Ewformprt:t.Ewformprt,SteufRef:t.SteufRef,KtschRef:t.KtschRef,EwformRef:t.EwformRef};n.EqPRT.push(w);if(t.EquipmentCatogory==="L"&&t.lam){var T={Equi:t.Equnr,Lrpid:t.lam.Lrpid,Strtptatr:t.lam.Strtptatr,Endptatr:t.lam.Endptatr,Length:t.lam.Length.toString(),LinUnit:t.lam.LinUnit,Startmrkr:t.lam.Startmrkr,Endmrkr:t.lam.Endmrkr,Mrkdisst:t.lam.Mrkdisst,Mrkdisend:t.lam.Mrkdisend,MrkrUnit:t.lam.MrkrUnit};n.EqLAM.push(T)}var v={Equi:t.Equnr,Title:t.TitleCode,Name1:t.Name1,Name2:t.Name2,Name3:t.Name3,Name4:t.Name4,Sort1:t.Sort1,Sort2:t.Sort2,NameCo:t.NameCo,PostCod1:t.PostCod1,City1:t.City1,Building:t.Building,Floor:t.Floor,Roomnum:t.Roomnum,Strsuppl1:t.Strsuppl1,Strsuppl2:t.Strsuppl2,Strsuppl3:t.Strsuppl3,Location:t.AddrLocation,RefPosta:t.RefPosta,Landx:t.Landx,TimeZone:t.TimeZone,RfePost:t.Region,Regiotxt:t.RegionDesc};n.EqAddr.push(v);var l=t.intlAddr;if(l){for(var d=0;d<l.length;d++){n.EqAddrI.push(l[d])}}var S=t.classItems;if(S){if(S.length>0){for(var M=0;M<S.length;M++){var E={Equi:t.Equnr,Classtype:S[M].Classtype,Class:S[M].Class,Clstatus1:S[M].Clstatus1};n.EqClass.push(E)}}}var f=t.characteristics;if(f){if(f.length>0){for(var y=0;y<f.length;y++){var A={Equi:t.Equnr,Atnam:f[y].Atnam,Textbez:f[y].Textbez,Atwrt:f[y].Atwrt,Class:f[y].Class};n.EqVal.push(A)}}}}this.getView().byId("idPageIntlAddr").setBusy(true);var P=this.getView().getModel();if(n.FLAddrI.length>0){n.FLAddrI=$.map(n.FLAddrI,function(e){return $.extend(true,{},e)});for(var N=0;N<n.FLAddrI.length>0;N++){delete n.FLAddrI[N].AdNationEnable}}if(n.EqAddrI.length>0){n.EqAddrI=$.map(n.EqAddrI,function(e){return $.extend(true,{},e)});for(var N=0;N<n.EqAddrI.length>0;N++){delete n.EqAddrI[N].AdNationEnable}}P.create("/ChangeRequestSet",n,{success:function(t){e.getView().byId("idPageIntlAddr").setBusy(false);var r=t;var a=[];for(var n=0;n<r.Messages.results.length;n++){a.push({type:s.getMessageType(r.Messages.results[n].Type),title:r.Messages.results[n].Message})}e.createMessagePopover(a,"")},error:function(t){e.getView().byId("idPageIntlAddr").setBusy(false);var r=[],a=[];if(JSON.parse(t.responseText).error.innererror.errordetails===undefined||JSON.parse(t.responseText).error.innererror.errordetails.length===0){r[0]=JSON.parse(t.responseText).error.message.value}else{for(var n=0;n<JSON.parse(t.responseText).error.innererror.errordetails.length;n++){r[n]=JSON.parse(t.responseText).error.innererror.errordetails[n].message}}var s=r.join("\n");sap.m.MessageBox.show(s,{title:"Error",icon:sap.m.MessageBox.Icon.ERROR,onClose:function(){}})}})},_getMessagePopover:function(){if(!this._oMessagePopover){this._oMessagePopover=sap.ui.xmlfragment("ugieamui.mdg.eam.lib.popover.MessagePopover",this);this.getView().addDependent(this._oMessagePopover)}return this._oMessagePopover},handleMessagePopoverPress:function(e){this._getMessagePopover().openBy(e.getSource())},createMessagePopover:function(e,t){var r=[];var a,n=this._getMessagePopover();if(typeof e==="string"){r.push({type:t,title:e,message:e})}else if(Array.isArray(e)){r=e;for(var s=0;s<r.length;s++){r[s].message=r[s].title}}sap.ui.getCore().getMessageManager().removeAllMessages();for(var s=0;s<r.length;s++){a=new d({message:r[s].message,type:r[s].type,target:"/Dummy",processor:this.getView().getModel()});sap.ui.getCore().getMessageManager().addMessages(a)}n.toggle(this.getView().byId("idMessagePopover"));this.getView().byId("idMessagePopover").setEnabled(true);this.getView().byId("idMessagePopover").setText(r.length+"")},streetVH:function(e){var t=this;var r=e.getSource();var a=t.getView().getModel(t.oModelName);var n=a.getData();var s={title:t.getView().getModel("i18n").getProperty("STREET"),noDataText:t.getView().getModel("i18n").getProperty("LOAD")+"...",columns:[new sap.m.Column({demandPopin:true,minScreenWidth:"Tablet",header:[new sap.m.Text({text:"{i18n>STREET}"})]}),new sap.m.Column({demandPopin:true,minScreenWidth:"Tablet",header:[new sap.m.Text({text:"{i18n>CITY}"})]}),new sap.m.Column({demandPopin:true,minScreenWidth:"Tablet",header:[new sap.m.Text({text:"{i18n>CITY_EXT}"})]}),new sap.m.Column({demandPopin:true,minScreenWidth:"Tablet",header:[new sap.m.Text({text:"{i18n>RGIN}"})]}),new sap.m.Column({demandPopin:true,minScreenWidth:"Tablet",header:[new sap.m.Text({text:"{i18n>LANGUAGE}"})]}),new sap.m.Column({demandPopin:true,minScreenWidth:"Tablet",header:[new sap.m.Text({text:"{i18n>CNTRY}"})]}),new sap.m.Column({demandPopin:true,minScreenWidth:"Tablet",header:[new sap.m.Text({text:"{i18n>STREET_NUM}"})]}),new sap.m.Column({demandPopin:true,minScreenWidth:"Tablet",header:[new sap.m.Text({text:"{i18n>STREET}"})]}),new sap.m.Column({demandPopin:true,minScreenWidth:"Tablet",header:[new sap.m.Text({text:"{i18n>CITY_NUM}"})]})],items:{path:"/StrtNameSet",template:new sap.m.ColumnListItem({type:"Active",unread:false,cells:[new sap.m.Text({text:"{Street}"}),new sap.m.Text({text:"{CityName}"}),new sap.m.Text({text:"{CityExt}"}),new sap.m.Text({text:"{Region}"}),new sap.m.Text({text:"{Langu}"}),new sap.m.Text({text:"{Country}"}),new sap.m.Text({text:"{StrtCode}"}),new sap.m.Text({text:"{McStreet}"}),new sap.m.Text({text:"{CityCode}"})]})},confirm:function(e){n.Streeti=e.getParameter("selectedItem").getCells()[0].getText();n.StreetiVS="None";n.City1i=e.getParameter("selectedItem").getCells()[1].getText();n.City1iVS="None";a.refresh()}};var i="/StrtNameSet";var l=[];var d=t.getView().getModel("valueHelp");var m=[new sap.m.Text({text:"{Street}"}),new sap.m.Text({text:"{CityName}"}),new sap.m.Text({text:"{CityExt}"}),new sap.m.Text({text:"{Region}"}),new sap.m.Text({text:"{Langu}"}),new sap.m.Text({text:"{Country}"}),new sap.m.Text({text:"{StrtCode}"}),new sap.m.Text({text:"{McStreet}"}),new sap.m.Text({text:"{CityCode}"})];var p=o.getValueHelp(d,i,m,l,s,"Street","StrtCode");p.open();p.setModel(t.getView().getModel("i18n"),"i18n")},cityVH:function(e){var t=this;var r=e.getSource();var a=t.getView().getModel(t.oModelName);var n=a.getData();var s={title:t.getView().getModel("i18n").getProperty("CITY"),noDataText:t.getView().getModel("i18n").getProperty("LOAD")+"...",columns:[new sap.m.Column({demandPopin:true,minScreenWidth:"Tablet",header:[new sap.m.Text({text:"{i18n>CITY}"})]}),new sap.m.Column({demandPopin:true,minScreenWidth:"Tablet",header:[new sap.m.Text({text:"{i18n>CITY_EXT}"})]}),new sap.m.Column({demandPopin:true,minScreenWidth:"Tablet",header:[new sap.m.Text({text:"{i18n>RGIN}"})]}),new sap.m.Column({demandPopin:true,minScreenWidth:"Tablet",header:[new sap.m.Text({text:"{i18n>CNTRY}"})]}),new sap.m.Column({demandPopin:true,minScreenWidth:"Tablet",header:[new sap.m.Text({text:"{i18n>CITY_NUM}"})]}),new sap.m.Column({demandPopin:true,minScreenWidth:"Tablet",header:[new sap.m.Text({text:"{i18n>CITY}"})]}),new sap.m.Column({demandPopin:true,minScreenWidth:"Tablet",header:[new sap.m.Text({text:"{i18n>LANGUAGE}"})]})],items:{path:"/CitySet",template:new sap.m.ColumnListItem({type:"Active",unread:false,cells:[new sap.m.Text({text:"{CityName}"}),new sap.m.Text({text:"{CityExt}"}),new sap.m.Text({text:"{Region}"}),new sap.m.Text({text:"{Country}"}),new sap.m.Text({text:"{CityCode}"}),new sap.m.Text({text:"{CityName}"}),new sap.m.Text({text:"{Langu}"})]})},confirm:function(e){n.City1i=e.getParameter("selectedItem").getCells()[0].getText();n.City1iVS="None";a.refresh()}};var i="/CitySet";var l=[];var d=t.getView().getModel("valueHelp");var m=[new sap.m.Text({text:"{CityName}"}),new sap.m.Text({text:"{CityExt}"}),new sap.m.Text({text:"{Region}"}),new sap.m.Text({text:"{Country}"}),new sap.m.Text({text:"{CityCode}"}),new sap.m.Text({text:"{CityName}"}),new sap.m.Text({text:"{Langu}"})];var p=o.getValueHelp(d,i,m,l,s,"CityName","CityCode");p.open();p.setModel(t.getView().getModel("i18n"),"i18n")},_changeStreetI:function(e){var t=this;var r=e.getSource();var a=t.getView().getModel(t.oModelName);var n=a.getData();var s=n.Streeti;var i=s.replace(/^[ ]+|[ ]+$/g,"");if(i!==""){var o="/StrtNameSet";var l=[new sap.ui.model.Filter("Street","EQ",i)];var d=t.getView().getModel("valueHelp");var m=function(e){if(e.results.length>0){n.Streeti=e.results[0].Street;n.StreetiVS="None";n.City1i=e.results[0].CityName;n.City1iVS="None"}else{n.StreetiVS="Error"}a.setData(n)};var p=function(e){var t=JSON.parse(e.responseText);var r=t.error.message.value;n.StreetiVS="Error";a.setData(n)};t._readData(o,d,m,p,l)}},_changeCityI:function(e){var t=this;var r=e.getSource();var a=t.getView().getModel(t.oModelName);var n=a.getData();var s=n.City1i;var i=s.replace(/^[ ]+|[ ]+$/g,"");if(i!==""){var o="/CitySet";var l=[new sap.ui.model.Filter("CityName","EQ",i)];var d=t.getView().getModel("valueHelp");var m=function(e){if(e.results.length>0){n.City1i=e.results[0].CityName;n.City1iVS="None"}else{n.City1iVS="Error"}a.setData(n)};var p=function(e){var t=JSON.parse(e.responseText);var r=t.error.message.value;n.City1iVS="Error";a.setData(n)};t._readData(o,d,m,p,l)}}})});