sap.ui.define(["ugiaiwui/mdg/aiw/request/controller/BaseController","sap/ui/model/json/JSONModel","sap/ui/core/routing/History","ugiaiwui/mdg/aiw/request/model/formatter","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/m/MessageBox","ugiaiwui/mdg/aiw/library/js/ValueHelpProvider","ugiaiwui/mdg/aiw/request/util/ValueHelpRequest","sap/ui/core/message/Message"],function(e,t,r,s,a,i,l,n,o,g){"use strict";return e.extend("ugiaiwui.mdg.aiw.request.controller.DetailObjectNetwork",{formatter:s,onInit:function(){this._oView=this.getView();this._oComponent=sap.ui.component(sap.ui.core.Component.getOwnerIdFor(this._oView));var e=this._oComponent.getModel();e.setDefaultCountMode(sap.ui.model.odata.CountMode.None);this.getView().setModel(e);var r=this._oComponent.getModel("NewModel");this.getView().setModel(r,"valueHelp");var s=this._oComponent.getModel("NewModel2");this.getView().setModel(s,"valueHelp2");this.getRouter().getRoute("ONdetail").attachPatternMatched(this._onRouteMatched,this);var a={delflgVisible:false};var i=new t(a);this.getView().setModel(i,"FieldsVisibleModel");var l=this.getView().createId("lamFrag");this.lam=sap.ui.core.Fragment.byId(l,"lamSimpleForm");this.oModelName="AIWListONModel";var n=sap.ui.getCore().getMessageManager();this.getView().setModel(n.getMessageModel(),"message");n.registerObject(this.getView(),true)},_onRouteMatched:function(e){var r=e.getParameter("name");if(r==="ONdetail"){var s=this;this.currentObj=undefined;var a=sap.ui.getCore().getModel("AIWListONModel");var i=a.getData();this.sPath=decodeURIComponent(e.getParameter("arguments").itemPath);this.action=e.getParameter("arguments").action;this.netId=e.getParameter("arguments").netId;this.objType=e.getParameter("arguments").objType;this.status=e.getParameter("arguments").status;this.mode=e.getParameter("arguments").mode;var l={};var n=new t;var o=this.getView().getModel("FieldsVisibleModel");var g=o.getData();this.getView().byId("idBtnCheck").setVisible(true);if(this.action==="Change"){l.titleName=this.getView().getModel("i18n").getProperty("ChangeONHeader");this.existFlag=false;for(var d=0;d<i.length;d++){if(i[d].Objnetwrk===this.netId){this.existFlag=true;this.currentObj=i[d];n.setData(this.currentObj);this.getView().setModel(n,"ONDetailModel");s.attachModelEventHandlers(n);if(this.lamSwitch&&this.lamSwitch==="X"){if(this.currentObj.Objnetwrk!==""&&this.currentObj.NetIDValueState!=="Error"){this.currentObj.lam.enableMarker=true}this.lam.setVisible(true);this.lam.setModel(new t(this.currentObj),"AIWLAM")}else{this.lam.setVisible(false)}break}}if(!this.existFlag){this.readNetworkData(this.netId,this.objType,this.status)}this.oModelUpdateFlag=false;if(this.status==="true"){this.disableFields()}else{this.enableFields()}if(sap.ui.getCore().getModel("refreshModel")!==undefined){var u=sap.ui.getCore().getModel("refreshModel");u.setProperty("/refreshSearch",false)}}else{var a=sap.ui.getCore().getModel("AIWListONModel");this.currentObj=a.getProperty(this.sPath);n.setData(this.currentObj);this.getView().setModel(n,"ONDetailModel");this.enableFields();if(this.currentObj.onType!==undefined&&this.currentObj.onType==="Change"){l.titleName=this.getView().getModel("i18n").getProperty("ChangeONHeader")}else{l.titleName=this.getView().getModel("i18n").getProperty("CreateONHeader")}if(this.mode==="request"){g.delflgVisible=false;if(this.lamSwitch&&this.lamSwitch==="X"){if(this.currentObj.Objnetwrk!==""&&this.currentObj.NetIDValueState!=="Error"){this.currentObj.lam.enableLrp=true}this.lam.setVisible(true);this.lam.setModel(new t(this.currentObj),"AIWLAM");this.getView().byId("networkGrp").setVisible(true);this.getView().byId("networkGrpDesc").setVisible(true);this.getView().byId("networkTyp").setVisible(true);this.getView().byId("networkTypDesc").setVisible(true)}else{this.lam.setVisible(false);this.getView().byId("networkGrp").setVisible(false);this.getView().byId("networkGrpDesc").setVisible(false);this.getView().byId("networkTyp").setVisible(false);this.getView().byId("networkTypDesc").setVisible(false)}}else{this.getView().byId("idBtnCheck").setVisible(false);l.titleName=this.getView().getModel("i18n").getProperty("ONAppHdr");g.delflgVisible=true;this.disableFields();if(this.lamSwitch&&this.lamSwitch==="X"){this.lam.setVisible(true);this.currentObj.lam.enableLrp=false;this.currentObj.lam.enableMarker=false;this.lam.setModel(new t(this.currentObj),"AIWLAM");this.getView().byId("networkGrp").setVisible(true);this.getView().byId("networkGrpDesc").setVisible(true);this.getView().byId("networkTyp").setVisible(true);this.getView().byId("networkTypDesc").setVisible(true)}else{this.lam.setVisible(false);this.lam.setVisible(false);this.getView().byId("networkGrp").setVisible(false);this.getView().byId("networkGrpDesc").setVisible(false);this.getView().byId("networkTyp").setVisible(false);this.getView().byId("networkTypDesc").setVisible(false)}}o.setData(g)}var p=new t;p.setData(l);this.getView().setModel(p,"applicationModel")}else{return}},isLam:function(){var e=this;var r=this.getView().getModel("valueHelp");r.read("/LAM_switchSet('')",{success:function(r,s){e.lamSwitch=r.lam_switch;if(e.lamSwitch==="X"&&e.mode==="request"){e.lam.setVisible(true);e.currentObj.lam.enableLrp=true;if(e.currentObj.lam.Lrpid!==""){e.currentObj.lam.enableMarker=true}e.lam.setModel(new t(e.currentObj),"AIWLAM")}else{e.lam.setVisible(false);e.currentObj.lam.enableLrp=false;e.currentObj.lam.enableMarker=false;e.lam.setModel(new t(e.currentObj),"AIWLAM")}if(e.lamSwitch==="X"){e.getView().byId("networkGrp").setVisible(true);e.getView().byId("networkGrpDesc").setVisible(true);e.getView().byId("networkTyp").setVisible(true);e.getView().byId("networkTypDesc").setVisible(true)}else{e.getView().byId("networkGrp").setVisible(false);e.getView().byId("networkGrpDesc").setVisible(false);e.getView().byId("networkTyp").setVisible(false);e.getView().byId("networkTypDesc").setVisible(false)}},error:function(e){}})},onAfterRendering:function(){this.isLam()},onCancel:function(){var e=this.getView().getModel("i18n").getProperty("DATA_LOSS");var t=this.getView().getModel("i18n").getProperty("WARNING");sap.m.MessageBox.show(e,sap.m.MessageBox.Icon.WARNING,t,[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],function(e){if(e==="OK"){window.history.back()}})},onObjectChange:function(){var e=this.getView().byId("objType");if(e.getValue()!==""){e.setValueState("None");if(e.getSelectedKey()==="FL"){this.getView().byId("linkFrmEqCol").setVisible(false);this.getView().byId("linkToEqCol").setVisible(false);this.getView().byId("linkObjEqCol").setVisible(false);this.getView().byId("linkObjFlCol").setVisible(true);this.getView().byId("linkFrmFlCol").setVisible(true);this.getView().byId("linkToFlCol").setVisible(true)}if(e.getSelectedKey()==="EQ"){this.getView().byId("linkFrmEqCol").setVisible(true);this.getView().byId("linkToEqCol").setVisible(true);this.getView().byId("linkObjEqCol").setVisible(true);this.getView().byId("linkObjFlCol").setVisible(false);this.getView().byId("linkFrmFlCol").setVisible(false);this.getView().byId("linkToFlCol").setVisible(false)}var t=this.getView().byId("netId").getValue();if(t!==""){this.getView().byId("newLink").setEnabled(true)}else{this.getView().byId("newLink").setEnabled(false)}}},onTextChange:function(){var e=this.getView().byId("shortTxt");if(e.getValue()!==""){e.setValueState("None")}},getCurrentTime:function(){var e=new Date;var t=e.getHours();if(t<10){t="0"+t}var r=e.getMinutes();if(r<10){r="0"+r}var s=e.getSeconds();if(s<10){s="0"+s}return t+":"+r+":"+s},getCurrentDate:function(){var e=new Date;var t=e.getMonth();var r=e.getDate();var s=e.getFullYear();if(t<9){t=t+1;t="0"+t}else{t=t+1}if(r<10){r="0"+r}return t+"/"+r+"/"+s},onLiveChange:function(e){if(e.getSource().getValue()===" "){e.getSource().setValue("")}e.getSource().setValueState("None");e.getSource().setValueStateText("")},disableFields:function(){var e=this;var t={enable:false,enableLRP:false};var r=new sap.ui.model.json.JSONModel;r.setData(t);e.getView().setModel(r,"mainView")},enableFields:function(){var e=this;var t={enable:true,enableLRP:false};var r=new sap.ui.model.json.JSONModel;r.setData(t);e.getView().setModel(r,"mainView")},readNetworkData:function(e,r,s){var a=this;var i=this.getView().getModel();var l=[new sap.ui.model.Filter("Objnetwrk","EQ",e),new sap.ui.model.Filter("Kantyp","EQ",r)];var n=["ONLAM","ONText","ONetwork","ONWClass","ONVal","ONALAM","ONatevt","ONattrp","ONLink","ONLLAM"];var o="/ChangeRequestSet";this.getView().byId("detailPage").setBusy(true);i.read(o,{filters:l,urlParameters:{$expand:n},success:function(e){a.getView().byId("detailPage").setBusy(false);if(e.results.length>0){a.match=true;var r=e.results[0];var s=r.Message;if(s!==""){a.createMessagePopover(s,"Error")}var i={Objnetwrk:"",Netgrp:"",Netwtyp:"",Netxt:"",Ntobjtyp:"",NetgrpDesc:"",NetwtypDesc:"",NetIDValueState:"None",NetIDValueStateText:"",NetgrpValueState:"None",NetwtypValueState:"None",ShrtTxtValueState:"None",NetIDEnable:false,lam:{Lrpid:"",LrpidDesc:"",Strtptatr:"",Endptatr:"",Length:0,LinUnit:"",LinUnitDesc:"",Startmrkr:"",Endmrkr:"",Mrkdisst:"",Mrkdisend:"",MrkrUnit:"",enableLrp:true,enableMarker:true,LrpidVS:"None",StrtptatrVS:"None",EndptatrVS:"None",LinUnitVS:"None",StartmrkrVS:"None",EndmrkrVS:"None",MrkdisstVS:"None",MrkdisendVS:"None",MrkrUnitVS:"None"}};var l=r.ONetwork.results;if(l.length>0){var n=l[0];i.Objnetwrk=n.Objnetwrk;i.Netgrp=n.Netgrp;i.NetgroupTxt=n.NetgroupTxt;i.Netwtyp=n.Netwtyp;i.NettypeTxt=n.NettypeTxt;i.Netxt=n.Netxt}var o=r.ONLAM.results;if(o.length>0){i.lam.Lrpid=o[0].Lrpid;i.lam.LrpidDesc=o[0].LrpDescr;i.lam.Objnetwrk=n.Objnetwrk;i.lam.Strtptatr=o[0].Strtptatr;i.lam.Endptatr=o[0].Endptatr;i.lam.Length=o[0].Length;i.lam.LinUnit=o[0].LinUnit;i.lam.Startmrkr=o[0].Startmrkr;i.lam.Endmrkr=o[0].Endmrkr;i.lam.Mrkdisst=o[0].Mrkdisst;i.lam.Mrkdisend=o[0].Mrkdisend;i.lam.MrkrUnit=o[0].MrkrUnit}if(a.status==="true"){i.lam.enableLrp=false;i.lam.enableMarker=false}var g=new t(i);a.getView().setModel(g,"ONDetailModel");a.getView().setModel(g,"AIWLAM");a.attachModelEventHandlers(g)}},error:function(e){}})},attachModelEventHandlers:function(e){e.attachPropertyChange(this.handlePropertyChanged,this)},handlePropertyChanged:function(){this.oModelUpdateFlag=true},clearFields:function(){var e=this;e.getView().byId("netId").setValueState("None");e.getView().byId("shortTxt").setValueState("None")},onDonePress:function(e){var t=e.getSource().getId();if(this.mode==="request"){var s=this;var a=this.getView().byId("netId");var i=this.getView().byId("shortTxt");var l=s.getView().getModel("ONDetailModel");var n=l.getData();var o=this.getView().createId("lamFrag");var g=sap.ui.core.Fragment.byId(o,"startMarker");var d=sap.ui.core.Fragment.byId(o,"endMarker");if(a.getValue()===""||i.getValue()===""||a.getValueState()==="Error"||i.getValueState()==="Error"){if(a.getValue()===""||a.getValueState()==="Error"){n.NetIDValueState="Error"}if(i.getValue()===""||i.getValueState()==="Error"){n.ShrtTxtValueState="Error"}l.setData(n);var u=this.getView().getModel("i18n").getProperty("MANDMSG");this.createMessagePopover(u,"Error");return}if(t.indexOf("idBtnCheck")>-1){this.validateCheck();return}if(this.action==="Change"){if(this.oModelUpdateFlag===true){var p=sap.ui.getCore().getModel("AIWListONModel").getData();if(!this.existFlag){var l=s.getView().getModel("ONDetailModel");p.push(l.getData())}sap.ui.getCore().getModel("AIWListONModel").refresh()}}s.clearFields()}var h=r.getInstance().getPreviousHash();if(h!==undefined){history.go(-1)}},validateCheck:function(){var e=this;var t=e.getView().getModel("ONDetailModel").getData();var r=sap.ui.getCore().getModel("tempCrTypeModel").getData();var a={ChangeRequestType:r.crtype,CrDescription:r.desc,IsDraft:"C",Messages:[],FuncLoc:[],FLAddr:[],FLLAM:[],FLClass:[],FLVal:[],Equipment:[],EqAddr:[],EqPRT:[],EqLAM:[],EqClass:[],EqVal:[],MSPoint:[],MSLAM:[],MSClass:[],MSVal:[],MPLAN:[],MPItem:[],MPLAM:[],MPOBList:[],MPCycle:[],MRBHeader:[],MRBItem:[],MRBSBIT:[],EBHeader:[],EBItem:[],EBSBIT:[],FBHeader:[],FBItem:[],FBSBIT:[],WBHeader:[],WBItem:[],WBSBIT:[],ONetwork:[],ONLAM:[],Workcenter:[],WCCost:[],GTList:[],GTOprs:[],GTComp:[],GTClass:[],GTVal:[],ETList:[],ETOprs:[],ETComp:[],ETClass:[],ETVal:[],FTList:[],FTOprs:[],FTComp:[],FTClass:[],FTVal:[],Olink:[],OLClass:[],OLVal:[]};var i={Objnetwrk:t.Objnetwrk,Netgrp:t.Netgrp,Netwtyp:t.Netwtyp,Netxt:t.Netxt,Ntobjtyp:t.Ntobjtyp};a.ONetwork.push(i);if(t.lam){var l={Objnetwrk:t.Objnetwrk,Lrpid:t.lam.Lrpid,Strtptatr:t.lam.Strtptatr,Endptatr:t.lam.Endptatr,Length:t.lam.Length.toString(),LinUnit:t.lam.LinUnit,Startmrkr:t.lam.Startmrkr,Endmrkr:t.lam.Endmrkr,Mrkdisst:t.lam.Mrkdisst,Mrkdisend:t.lam.Mrkdisend,MrkrUnit:t.lam.MrkrUnit};a.ONLAM.push(l)}this.getView().byId("detailPage").setBusy(true);var n=this.getView().getModel();n.create("/ChangeRequestSet",a,{success:function(t){e.getView().byId("detailPage").setBusy(false);var r=t;var a=[];for(var i=0;i<r.Messages.results.length;i++){a.push({type:s.getMessageType(r.Messages.results[i].Type),title:r.Messages.results[i].Message})}e.createMessagePopover(a,"")},error:function(t){e.getView().byId("detailPage").setBusy(false);var r=[],s=[];if(JSON.parse(t.responseText).error.innererror.errordetails===undefined||JSON.parse(t.responseText).error.innererror.errordetails.length===0){r[0]=JSON.parse(t.responseText).error.message.value}else{for(var a=0;a<JSON.parse(t.responseText).error.innererror.errordetails.length;a++){r[a]=JSON.parse(t.responseText).error.innererror.errordetails[a].message}}var i=r.join("\n");sap.m.MessageBox.show(i,{title:"Error",icon:sap.m.MessageBox.Icon.ERROR,onClose:function(){}})}})},_getMessagePopover:function(){if(!this._oMessagePopover){this._oMessagePopover=sap.ui.xmlfragment("ugieamui.mdg.eam.lib.popover.MessagePopover",this);this.getView().addDependent(this._oMessagePopover)}return this._oMessagePopover},handleMessagePopoverPress:function(e){this._getMessagePopover().openBy(e.getSource())},createMessagePopover:function(e,t){var r=[];var s,a=this._getMessagePopover();if(typeof e==="string"){r.push({type:t,title:e,message:e})}else if(Array.isArray(e)){r=e;for(var i=0;i<r.length;i++){r[i].message=r[i].title}}sap.ui.getCore().getMessageManager().removeAllMessages();for(var i=0;i<r.length;i++){s=new g({message:r[i].message,type:r[i].type,target:"/Dummy",processor:this.getView().getModel()});sap.ui.getCore().getMessageManager().addMessages(s)}a.toggle(this.getView().byId("idMessagePopover"));this.getView().byId("idMessagePopover").setEnabled(true);this.getView().byId("idMessagePopover").setText(r.length+"")},aiwNetIdChange:function(e){var t=this;var r=e.getParameters().newValue;var s=this.getView().getModel("valueHelp");var a=e.getSource();var i=false;var l=parseInt(this.sPath.split("/")[1]);var n=t.lam.getModel("AIWLAM");var o=n.getData();if(r!==""){if(r!==undefined){var g=r.toUpperCase();var d=sap.ui.getCore().getModel("AIWListONModel").getData();if(d.length>0){for(var u=0;u<d.length;u++){if(u!==l){if(d[u].Objnetwrk===r){var p="Object Network "+r+" already locked in this CR";a.setValueState("Error");i=true;this.createMessagePopover(p,"Error");break}}}}if(!i){var h=[new sap.ui.model.Filter("Netwid","EQ",g)];s.read("/NetidSet",{filters:h,success:function(e){if(e.results.length>0){a.setValueState("Error");t.createMessagePopover("Object Network "+e.results[0].Netwid+" already exists","Error");a.setValue(e.results[0].Netwid);o.lam.enableLrp=false;n.setData(o)}else{a.setValue(r.toUpperCase());a.setValueState("None");o.lam.enableLrp=true;n.setData(o)}},error:function(e){a.setValueState("Error");o.lam.enableLrp=false;n.setData(o)}})}}}},onNetWorkGrpVH:function(e){this.networkGrpVH("networkGrp",e)},networkGrpVH:function(e,t){var r=this;var s;s=this.getView().byId(e);var a=this.getView().byId("networkGrpDesc");var i={title:this.getView().getModel("i18n").getProperty("NET_GRP"),noDataText:this.getView().getModel("i18n").getProperty("LOAD")+"...",items:{path:"/NetGrpSet",template:new sap.m.StandardListItem({title:"{Netgrp}",description:"{Netgrp_txt}"})},confirm:function(e){s.setValueState("None");s.setValueStateText("");a.setValue(e.getParameters().selectedItem.getProperty("description"));s.setValue(e.getParameters().selectedItem.getProperty("title"))}};var l="/NetGrpSet";var o=this.getView().getModel("valueHelp");var g=n.getSelectDialog(o,l,[],i,"Netgrp","Netgrp_txt");g.setModel(this.getView().getModel("i18n"),"i18n");g.open()},onNetWorkTypeVH:function(e){this.networkTypeVH("networkTyp",e)},networkTypeVH:function(e,t){var r=this;var s;s=this.getView().byId(e);var a=this.getView().byId("networkTypDesc");var i={title:this.getView().getModel("i18n").getProperty("NET_TYP"),noDataText:this.getView().getModel("i18n").getProperty("LOAD")+"...",items:{path:"/NetTypSet",template:new sap.m.StandardListItem({title:"{NETYP}",description:"{NETYP_TXT}"})},confirm:function(e){s.setValueState("None");s.setValueStateText("");a.setValue(e.getParameters().selectedItem.getProperty("description"));s.setValue(e.getParameters().selectedItem.getProperty("title"))}};var l="/NetTypSet";var o=this.getView().getModel("valueHelp");var g=n.getSelectDialog(o,l,[],i,"NETYP","NETYP_TXT");g.setModel(this.getView().getModel("i18n"),"i18n");g.open()},netGrpChange:function(){var e=this.getView().byId("networkGrp");if(e.getValue()===""){this.getView().byId("networkGrpDesc").setValue()}e.setValueState("None")},onNetGrpChange:function(){var e=this.getView().byId("networkGrp");var t=e.getValue().toUpperCase();e.setValue(t);this._networkGroup(e)},_networkGroup:function(e){var t=e.getValue();var r=this.getView().byId("networkGrpDesc");var s=t.replace(/^[ ]+|[ ]+$/g,"");if(s!==""){var a=[new sap.ui.model.Filter("Netgrp","EQ",t)];var i="/NetGrpSet";var l=this.getView().getModel("valueHelp");l.read(i,{filters:a,success:function(t,a){if(t.results.length>0){e.setValueState("None");r.setValue(t.results[0].Netgrp_txt);e.setValue(s)}else{e.setValueState("Error");r.setValue();e.setValueStateText("Invalid Entry")}},error:function(t){e.setValueState("Error");var r=JSON.parse(t.response.body);var s=r.error.message.value;e.setValueStateText(s)}})}else{e.setValue(s)}},netTypeChange:function(){var e=this.getView().byId("networkTyp");if(e.getValue()===""){this.getView().byId("networkTypDesc").setValue()}e.setValueState("None")},onNetTypeChange:function(){var e=this.getView().byId("networkTyp");var t=e.getValue().toUpperCase();e.setValue(t);this._networkType(e)},_networkType:function(e){var t=e.getValue();var r=this.getView().byId("networkTypDesc");var s=t.replace(/^[ ]+|[ ]+$/g,"");if(s!==""){var a=[new sap.ui.model.Filter("NETYP","EQ",t)];var i="/NetTypSet";var l=this.getView().getModel("valueHelp");l.read(i,{filters:a,success:function(t,a){if(t.results.length>0){e.setValueState("None");r.setValue(t.results[0].NETYP_TXT);e.setValue(s)}else{e.setValueState("Error");r.setValue();e.setValueStateText("Invalid Entry")}},error:function(t){e.setValueState("Error");var r=JSON.parse(t.response.body);var s=r.error.message.value;e.setValueStateText(s)}})}else{e.setValue(s)}}})});