sap.ui.define(["ugiaiwui/mdg/aiw/request/controller/BaseController","sap/ui/model/json/JSONModel","ugiaiwui/mdg/aiw/request/model/formatter","sap/ui/core/routing/History","ugiaiwui/mdg/aiw/request/util/ValueHelpRequest"],function(e,t,r,o,n){"use strict";return e.extend("ugiaiwui.mdg.aiw.request.controller.TLSrvPckgeDetail",{formatter:r,onInit:function(){var e,r=new t({busy:true,delay:0});this.getRouter().getRoute("tlSrvPckge").attachPatternMatched(this._onObjectMatched,this);e=this.getView().getBusyIndicatorDelay();this.setModel(r,"objectView");this.getOwnerComponent().getModel().metadataLoaded().then(function(){r.setProperty("/delay",e)});var o=sap.ui.component(sap.ui.core.Component.getOwnerIdFor(this.getView()));var n=o.getModel();n.setDefaultCountMode(sap.ui.model.odata.CountMode.None);this.getView().setModel(n);var i=o.getModel("NewModel");this.getView().setModel(i,"valueHelp");var a=o.getModel("NewModel2");this.getView().setModel(a,"valueHelp2")},typeCheck:function(e){if(e){var t="";if(typeof e==="boolean"){return e}else if(typeof e==="string"){if(e.indexOf("false")>-1){t=false}else if(e.indexOf("true")>-1){t=true}else if(e.indexOf("X")>-1){t=true}else{t=false}return t}}else{return false}},onNavBack:function(){this.updateWorkforOperation()},parseQualification:function(e){if(e==="S"||e==="C"||e==="QP"){return true}else{return false}},_onObjectMatched:function(e){var t=new sap.ui.model.json.JSONModel;var r=sap.ui.getCore().getModel("tlDetailModel");t.setData(r.getProperty(decodeURIComponent(e.getParameter("arguments").itemPath)));this.setModel(t,"tlSrvPckge");var o=r.getData().lOperation;var n=this.getModel("tlSrvPckge").getData().Plnal;var i=this.getModel("tlSrvPckge").getData().Vornr;for(var a=0;a<o.length;a++){if(o[a].Plnal===n&&o[a].Vornr===i){this.Plant=o[a].Werks;this.slopIdc=a;break}}this.getView().bindElement({path:decodeURIComponent(e.getParameter("arguments").itemPath),model:"tlSrvPckge"})},onLiveChange:function(e){if(e.getSource().getValue()===" "){e.getSource().setValue("")}e.getSource().setValueState("None")},onActNumVH:function(e){n.ActNumVH(e,this)},onActNumChange:function(e){n._ActNumchange(e,this)},onBUomSPVH:function(e){n.UOMVH(e,this)},onBUomSPChange:function(e){n._UOMchange(e,this)},onQtySPOchange:function(e){n.Qtychange(e,this)},onShrtTxtchange:function(e){n.ShrtTxtchange(e,this)},onCurKeyVH:function(e){var t=[new sap.ui.model.Filter("Werks","EQ",this.Plant)];n.CurKeyVH(e,this,t)},onCurKeyChange:function(e){var t=[new sap.ui.model.Filter("Werks","EQ",this.Plant)];n._CurKeychange(e,this,t)},onUnitOfWorkVH:function(e){n.UnitOfWorkVH(e,this)},onUnitOfWorkChange:function(e){n._UnitOfWorkchange(e,this)},deriveActQty:function(e,t,r){var o=this;var n=this.getView().getModel("valueHelp2");var i=this.getModel("tlSrvPckge").getData();if(t){i.UnitOfWork=t}if(r){i.BUomSP=r}var a="/SpackWrkDrvSet";var s=[new sap.ui.model.Filter("Meins","EQ",i.BUomSP),new sap.ui.model.Filter("Iwein","EQ",i.UnitOfWork),new sap.ui.model.Filter("Srvpos","EQ",i.ActNum),new sap.ui.model.Filter("IAmount","EQ",i.Qty)];n.read(a,{filters:s,success:function(e){if(e.results.length>0){var t=e.results[0];i.BUomSP=t.Meins;i.Work=t.OAmount;i.ActNum=t.Srvpos;i.Qty=t.IAmount;i.UnitOfWork=t.Iwein;o.getModel("tlSrvPckge").refresh()}},error:function(e){var t=[];if(JSON.parse(e.responseText).error.innererror.errordetails===undefined||JSON.parse(e.responseText).error.innererror.errordetails.length===0){t[0]=JSON.parse(e.responseText).error.message.value}else{for(var r=0;r<JSON.parse(e.responseText).error.innererror.errordetails.length;r++){t[r]=JSON.parse(e.responseText).error.innererror.errordetails[r].message}}var o=t.join("\n");sap.m.MessageBox.show(o,{title:"Error",icon:sap.m.MessageBox.Icon.ERROR,onClose:function(){}})}})},updateWorkforOperation:function(){var e=this;var t=sap.ui.getCore().getModel("tlDetailModel").getData().lOperation;var r=t[this.slopIdc].SrvPckgOvrw;var o=[];for(var n=0;n<r.length;n++){var i={Meins:r[n].BUomSP,Iwein:r[n].UnitOfWork,Srvpos:r[n].ActNum,OAmount:"",IAmount:r[n].Work};o.push(i)}var a={Work:"",WorkUnit:"",Anzzl:"",Werks:this.Plant,Duration:"",DurationUnit:"",SpackDetails:o};var s="/TLOprWrkDrvSet";var l=e.getView().getModel("valueHelp2");l.create(s,a,{success:function(r){t[e.slopIdc].Arbei=r.Work.trim();t[e.slopIdc].Arbeh=r.WorkUnit;t[e.slopIdc].WorkEnable=false;sap.ui.getCore().getModel("tlDetailModel").refresh();window.history.go(-1)},error:function(e){window.history.go(-1)}})}})});