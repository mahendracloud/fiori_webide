sap.ui.define(["ugiaiwui/mdg/aiw/request/controller/BaseController","sap/ui/model/json/JSONModel","ugiaiwui/mdg/aiw/request/model/formatter","ugiaiwui/mdg/aiw/request/util/ValueHelpRequest","ugiaiwui/mdg/aiw/request/util/CRPersoService","sap/m/TablePersoController","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(e,t,r,s,i,o,n,a){"use strict";return e.extend("ugiaiwui.mdg.aiw.request.controller.MyChangeRequest",{formatter:r,onInit:function(){var e=sap.ushell.Container.getService("UserInfo").getId();var r=sap.ushell.Container.getService("UserInfo").getUser().getLastName();this._oView=this.getView();this._oComponent=sap.ui.component(sap.ui.core.Component.getOwnerIdFor(this._oView));this._oRouter=this._oComponent.getRouter();var s=new t({name:e,fullName:r});this.getView().setModel(s,"mainView");this._oTPC=new o({table:this.getView().byId("myCRTab"),componentName:"ugiaiwui-mdg-aiw-request",persoService:i}).activate();var n=this._oComponent.getModel();n.setDefaultCountMode(sap.ui.model.odata.CountMode.None);this.getView().setModel(n);var a=this._oComponent.getModel("NewModel");this.getView().setModel(a,"valueHelp");var l=this._oComponent.getModel("NewModel2");this.getView().setModel(l,"valueHelp2");var u=this._oComponent.getModel("ApprovalModel");this.getView().setModel(u,"approveModel");var g=this},onAfterRendering:function(){var e=this;jQuery.sap.delayedCall(5,this,function(){e.getView().byId("myCRTab").setBusy(true);e.readChangeRequestCollection()})},onExit:function(){this._oTPC.destroyPersoService();this._oTPC.destroy()},onRefreshPress:function(){this.getView().byId("myCRTab").getBinding("items").refresh();this.getView().byId("myCRTab").getModel().refresh();jQuery.sap.delayedCall(0,this,function(){this.getView().byId("myCRTab").setBusy(true);this.readChangeRequestCollection()})},readChangeRequestCollection:function(){var e=this.getView().getModel("approveModel");var r="/ChangeRequestSet";var s=this.getView().byId("myCRTab");var i=[this.getInitialFilter(),this.getSearchFilters()];var o=function(e){if(e.results.length>0){var r=new t;r.setData(e.results);s.setModel(r);s.setBusy(false);this._oComponent.setModel(r,"crCollection")}else{s.setBusy(false)}}.bind(this);var n=function(e){var t=[];if(JSON.parse(e.responseText).error.innererror.errordetails===undefined||JSON.parse(e.responseText).error.innererror.errordetails.length===0){t[0]=JSON.parse(e.responseText).error.message.value}else{for(var r=0;r<JSON.parse(e.responseText).error.innererror.errordetails.length;r++){t[r]=JSON.parse(e.responseText).error.innererror.errordetails[r].message}}var i=t.join("\n");sap.m.MessageToast.show(i,{});s.setBusy(false)};this._readData(r,e,o,n,i,{})},onSearch:function(e){var t=e.getParameter("query");t=t.replace(/^[ ]+|[ ]+$/g,"");t=t.toUpperCase();var r=this.getView().byId("myCRTab").getItems();var s=0;for(var i=0;i<r.length;i++){if(t.length>0){var o=r[i].getBindingContext().getProperty("ChangeRequestId");var n=r[i].getBindingContext().getProperty("CrDescription");var a=r[i].getBindingContext().getProperty("CreatedBy");if(o.toUpperCase().indexOf(t)===-1&&n.toUpperCase().indexOf(t)===-1&&a.toUpperCase().indexOf(t)===-1){r[i].setVisible(false)}else{r[i].setVisible(true);s=s+1}}else{r[i].setVisible(true);s=r.length}}var l=this.getResourceBundle().getText("changeRequests",[s]);this.getView().byId("tableHeader").setText(l)},getInitialFilter:function(){return new n("Count",a.EQ,"")},getSearchFilters:function(){return new sap.ui.model.Filter({filters:[new n("OTC",a.EQ,"183"),new n("OTC",a.EQ,"237"),new n("OTC",a.EQ,"185"),new n("OTC",a.EQ,"1230"),new n("OTC",a.EQ,"1223"),new n("OTC",a.EQ,"493"),new n("OTC",a.EQ,"/UGI/TLFL"),new n("OTC",a.EQ,"/UGI/TLEQ"),new n("OTC",a.EQ,"/UGI/TL"),new n("OTC",a.EQ,"DRF_0038"),new n("OTC",a.EQ,"DRF_0039"),new n("OTC",a.EQ,"1345"),new n("OTC",a.EQ,"DRF_0013"),new n("OTC",a.EQ,"/UGI/WBSBM")],and:false})},onPersoButtonPressed:function(e){this._oTPC.openDialog()},onTablePersoRefresh:function(){i.resetPersData();this._oTPC.refresh()},onCRUpdateFinished:function(e){var t,r=e.getSource(),s=e.getParameter("total");if(s&&r.getBinding("items").isLengthFinal()){t=this.getResourceBundle().getText("changeRequests",[s])}else{t=this.getResourceBundle().getText("changeRequests")}this.getView().byId("tableHeader").setText(t)},onItemPress:function(e){this.showRequestDetail(e.getSource())},showRequestDetail:function(e){var t=e.getBindingContext().sPath;var r=parseInt(t.substr(1));var s=this.getView().byId("myCRTab").getModel().getData();var i=true;sap.ui.getCore().setModel({FirstLoadFlag:i},"onFirstLoadFlag");this._oRouter.navTo("mainDetail",{cReqNo:s[r].ChangeRequestId,itemPath:encodeURIComponent(t),crType:s[r].ChangeRequestType,crDesc:encodeURIComponent(s[r].CrDescription),Action:s[r].Action,Model:s[r].Model})}})});